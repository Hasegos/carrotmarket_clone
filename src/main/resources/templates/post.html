<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${post.title}">게시물 상세</title>
</head>
<body>
<h1 th:text="${post.title}">제목</h1>
<p th:text="${post.description}">내용</p>

<!-- username 입력 (로그인시 삭제) -->
<label>
    당신의 username:
    <input type="text" id="usernameInput" placeholder="dev, dev2 등"/>
</label>
<button type="button" id="checkBtn">확인</button>
<br/>

<!-- 구매자용: 방 생성 버튼 -->
<button type="button" id="createBtn" th:data-post-id="${post.id}">
    <!-- th:if="${#authentication.name} != ${post.user.username}" 필요 -->
    채팅하기
</button>

<!-- 판매자용: 방 목록 -->
<!-- <h3 th:if="${#authentication.name} == ${post.user.username}" > 채팅방 목록</h3>  (로그인시)-->
<!-- <ul id="roomList" th:if="${#authentication.name} == ${post.user.username}"></ul> -->

<h3>채팅방 목록</h3>
<ul id="roomList"></ul>

<script th:inline="javascript">
    /*<![CDATA[*/
        const usernameInput = document.getElementById('usernameInput'); // 로그인시 삭제

        const checkBtn      = document.getElementById('checkBtn'); // 로그인시 삭제
        const createBtn     = document.getElementById('createBtn');
        const roomList      = document.getElementById('roomList');

        const postId    = /*[[${post.id}]]*/ 0; // 게시물 id
        const postOwner = /*[[${post.user.username}]]*/; // 판매자
        // const currentUsername = /*[[${#authentication.name}]]*/ 'anonymous'; 로그인된 유저

        // 초기 숨김
        createBtn.style.display = 'none';
        roomList.style.display  = 'none';

        // “확인” 버튼 클릭 후 모드 결정
        checkBtn.addEventListener('click', () => {
            const u = usernameInput.value.trim();
            if (!u){ return alert('username을 입력하세요.') };

            currentUsername = u; // 구매자
            if (u === postOwner) {
                createBtn.style.display = 'none';
                roomList.style.display  = 'block';
                loadRoomList();
            }
            // 구매자 모드
            else {
                roomList.style.display  = 'none';
                createBtn.style.display = 'inline-block';
            }
        });

        // 구매자: 방 생성
        createBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const res = await fetch(`/chat/post/${postId}/rooms`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ username })
            });
            if (!res.ok) {
                alert('채팅방 생성 실패: ' + await res.text());
                return;
            }
            const dto = await res.json();
            location.href = `/chat/room/${dto.id}?username=${encodeURIComponent(currentUsername)}`;
        });

        // 판매자: 방 목록 로드
        async function loadRoomList() {
            const res = await fetch(`/chat/post/${postId}/rooms`);
            const list = await res.json();
            roomList.innerHTML = '';
            list.forEach(r => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.textContent = `방 #${r.id} (구매자:${r.userId})`;
                btn.onclick = () => location.href = `/chat/room/${r.id}?username=${encodeURIComponent(currentUsername)}`;
                li.append(btn);
                roomList.append(li);
            });
        }

        // 로그인 할시
        /*
            if(createBtn && currentUsername !== postOwner){
                 checkBtn.addEventListener('click', async () => {
                    const res = await fetch(`/chat/post/${postId}/rooms`, { method : 'POST' });
                    if(!res.ok){
                        alert("채팅방 생성 실패 : ' + await res.text());
                        return;
                    }
                    const dto = await res.json();
                    location.href=`/chat/room/${dto.id}`;
                });
            }

            async function loadRoomList() {
                 const res = await fetch(`/chat/post/${postId}/rooms`);
                 const list = await res.json();
                roomList.innerHTML = '';
                list.forEach(r => {
                    const li = document.createElement('li');
                    const btn = document.createElement('button');
                    btn.textContent = `방 #${r.id} (구매자:${r.userId})`;
                    btn.onclick = () => location.href = `/chat/room/${r.id}`;
                    li.append(btn);
                    roomList.append(li);
                });
            }
            // 현재 유저와 게시물을 올린 유저가 같다면
            if(roomList && currentUsername === postOwner){
                loadRoomList();
            }
        */
    /*]]>*/
</script>
</body>
</html>